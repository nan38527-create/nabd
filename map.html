<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - Grand Hotel</title>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        :root {
            --primary: #16243d;
            --secondary: #2a3851;            
            --accent: #D4AF37; /* Gold */
            --light: #f8f9fa;
            --dark: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 40px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1001; /* Above map */
        }

        header h1 {
            font-family: 'Tajawal', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
        }

        .home-btn {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .home-btn:hover {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .dashboard-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        #map {
            flex: 1;
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 1;
        }

        .sidebar {
            width: 380px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .panel h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel {
            position: relative; /* Required for spinner overlay */
        }

        .spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 15px;
            transition: opacity 0.3s ease;
        }

        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .route-step, .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: var(--light);
            transition: var(--transition);
        }

        .route-step .remove-step-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
        }
        .route-step:hover, .suggestion-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .route-step .icon, .suggestion-item .icon {
            font-size: 1.2rem;
            color: var(--accent);
            width: 25px;
            text-align: center;
            padding-top: 3px;
        }

        .route-step .details, .suggestion-item .details {
            flex: 1;
        }

        .route-step .title, .suggestion-item .title {
            font-weight: 600;
            color: var(--dark);
        }

        .route-step .time, .suggestion-item .info {
            font-size: 0.9rem;
            color: #666;
        }

        .add-to-route-btn {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 8px;
        }

        .add-to-route-btn:hover {
            background: var(--primary);
            color: white;
        }


        .suggestion-item.real-time {
            background: #fffbe6;
            border-left: 4px solid var(--accent);
        }

        .suggestion-item .info .fa-star {
            color: #f5c542;
        }

        .btn-directions {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-directions:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-directions.active {
            background: #d9534f; /* Danger color */
        }

        .directions-instructions {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            min-height: 20px;
        }
        /* AI Agent Modal Styles */
        .directions-actions {
            display: flex;
            gap: 10px;
        }

        .btn-clear-markers {
            padding: 12px;
            background: var(--light);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-clear-markers:hover {
            background: var(--secondary);
            color: white;
        }
        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1002;
            transition: var(--transition);
        }

        .floating-btn:hover {
            background: var(--accent);
            transform: scale(1.1);
        }

        .ai-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000; /* Changed from display: none to allow flex centering */
            display: none; /* Hidden by default */
        }

        .ai-modal-content {
            position: absolute;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            height: 70vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .ai-modal-header {
            padding: 15px 20px;
            background: var(--primary);
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .ai-modal-header h3 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            color: var(--accent);
            border: none;
        }

        .ai-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
        }

        .ai-user-msg {
            background: var(--light);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ai-bot-msg {
            background: var(--secondary);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .ai-chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .send-btn:hover {
            background: var(--secondary);
        }

        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
            body {
                height: auto; /* Allow body to scroll on mobile */
                overflow: auto;
            }
            header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            header h1 {
                font-size: 1.8rem;
            }
            .dashboard-container {
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }
            #map {
                height: 50vh; /* Give map a fixed height */
            }
            .sidebar {
                width: 100%;
                height: auto;
                overflow-y: visible; /* Allow sidebar to expand */
            }
        }

        /* --- START: Added CSS for Locate Button --- */
        .leaflet-control-locate a {
            font-size: 1.2rem;
            line-height: 26px;
            width: 30px;
            height: 30px;
            text-align: center;
            color: var(--primary);
        }
        .leaflet-control-locate a:hover {
            background-color: #f4f4f4;
        }
        /* --- END: Added CSS for Locate Button --- */
    </style>
</head>
<body>

    <header>
        <h1>Interactive Map</h1>
        <a href="homePage.html" class="home-btn"><i class="fas fa-home"></i> Return to Home Page</a>
    </header>

    <div class="dashboard-container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="panel" id="directions-panel">
                <h3><i class="fas fa-directions"></i> Get Directions</h3>
                <div class="directions-actions">
                    <button id="get-directions-btn" class="btn-directions">Start Planning Route</button>
                    <button id="clear-markers-btn" class="btn-directions btn-clear-markers" title="Clear temporary markers"><i class="fas fa-eraser"></i></button>
                </div>
                <p id="directions-instructions" class="directions-instructions"></p>
            </div>
            <div class="panel" id="route-panel">
                <h3><i class="fas fa-route"></i> Your Personalized Route</h3>
                <!-- Route steps will be injected here by JavaScript -->
            </div>
            <div class="panel" id="suggestions-panel">
                <h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>
                <!-- Suggestions will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Centralized Data File -->
    <script src="data.js"></script>

    <!-- AI Agent Button and Modal -->
    <button id="ai-agent-btn" class="floating-btn" aria-label="Open AI Agent">
        <i class="fas fa-robot"></i>
    </button>

    <div id="ai-modal" class="ai-modal-overlay">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3>Mood Advisor</h3>
                <button id="ai-close-btn" class="ai-close-btn">&times;</button>
            </div>
            <div class="ai-chat-messages" id="ai-chat-messages">
                <!-- Messages will be injected here -->
            </div>
            <div class="ai-chat-input">
                <input type="text" id="ai-user-input" class="chat-input" placeholder="Tell me how you feel...">
                <button id="ai-send-btn" class="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // 1. Initialize the map
        const map = L.map('map').setView([25.276987, 55.296249], 13); // Centered on Dubai

        // 2. Add a tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- START: Added Geolocation Logic ---
        // Function to find the user and show them on the map
        function locateUser() {
            // Show a spinner in the suggestions panel while we find the user and places
            showSpinner(document.getElementById('suggestions-panel'));
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const userLocation = [lat, lng];

                        // Update suggestions based on the user's location
                        updateSuggestionsBasedOnLocation(userLocation);

                        // Fly to the user's location on the map
                        map.flyTo(userLocation, 15);

                        // Add a special marker for the user's current location
                        L.marker(userLocation, {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<i class="fas fa-map-marker-alt" style="color: #007bff; font-size: 2rem;"></i>',
                                iconSize: [24, 40],
                                iconAnchor: [12, 40]
                            })
                        }).addTo(map).bindPopup("<b>You are here</b>").openPopup();
                    },
                    () => {
                        // Handle error (e.g., user denies location access)
                        console.log("Unable to retrieve your location. Defaulting to Dubai.");
                        // If location fails, just show the default suggestions
                        renderSuggestions(suggestionsData);
                        // The map will remain centered on the default location (Dubai)
                    }
                );
            } else {
                console.log("Geolocation is not supported by this browser.");
                renderSuggestions(suggestionsData);
            }
        }

        // Ask for the user's location when the page loads
        locateUser();
        // --- END: Added Geolocation Logic ---

        // --- START: Check for special requests from other pages ---
        function checkForSpecialRequests() {
            const mapRequest = localStorage.getItem('map_request');

            if (mapRequest === 'luxury_restaurants') {
                // Clear the flag so it doesn't run again on refresh
                localStorage.removeItem('map_request');
                
                // Clear default suggestions and show restaurants
                suggestionsPanel.innerHTML = '<h3><i class="fas fa-gem"></i> Luxury Restaurants</h3>';
                initialSuggestionMarkers.forEach(m => map.removeLayer(m));
                initialSuggestionMarkers = [];

                // Render restaurants on the map and in the sidebar
                renderLuxuryRestaurants(luxuryRestaurantsData);
            }
        }
        // 4. Populate Panels and Map
        const routePanel = document.getElementById('route-panel');
        const suggestionsPanel = document.getElementById('suggestions-panel');
        let currentRoute = [...routeData]; // Create a mutable copy of the route
        let allSuggestions = [...suggestionsData]; // Create a mutable copy
        let initialRouteMarkers = [];
        let initialSuggestionMarkers = [];
        let directionsControl = null;

        // Get current visitor ID for namespacing localStorage
        const visitorId = localStorage.getItem('visitorId') || '#guest';

        // --- START: Register Visitor ID ---
        // Add the current visitor to a master list for the chef dashboard
        let allVisitorIds = JSON.parse(localStorage.getItem('allVisitorIds') || '[]');
        if (!allVisitorIds.includes(visitorId)) {
            allVisitorIds.push(visitorId);
            localStorage.setItem('allVisitorIds', JSON.stringify(allVisitorIds));
        }
        // --- END: Register Visitor ID ---


        // --- START: Activity Logging for Admin Dashboard ---
        function logActivity(message, iconClass, type) {
            let activities = JSON.parse(localStorage.getItem('userActivities') || '[]');
            const newActivity = {
                message: `[${visitorId}] ${message}`, // Add visitor ID to message
                icon: iconClass,
                type: type, // e.g., 'alert', 'entry', 'info'
                time: new Date().toISOString()
            };
            activities.unshift(newActivity); // Add to the beginning
            localStorage.setItem('userActivities', JSON.stringify(activities.slice(0, 10))); // Keep only the latest 10

            // Log status for the admin panel
            if (type === 'alert') {
                localStorage.setItem(`${visitorId}_status`, 'Assistance Req.');
            }
        }
        // Function to update the visited places count in localStorage
        function updateVisitedPlacesCount() {
            const currentPlaceCount = routePanel.querySelectorAll('.route-step').length;
            localStorage.setItem(`${visitorId}_visitedPlacesCount`, currentPlaceCount);
        }

        // Function to update the average crowd level in localStorage
        function updateAverageCrowdLevel() {
            if (currentRoute.length === 0) {
                localStorage.setItem('averageCrowdLevel', '0');
                return;
            }
            const totalCrowdLevel = currentRoute.reduce((sum, place) => sum + place.crowdLevel, 0);
            const averageCrowdLevel = Math.round(totalCrowdLevel / currentRoute.length);
            localStorage.setItem(`${visitorId}_averageCrowdLevel`, averageCrowdLevel);
        }

        

        // Spinner Functions
        function showSpinner(panelElement) {
            const overlay = document.createElement('div');
            overlay.className = 'spinner-overlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            panelElement.appendChild(overlay);
        }

        function hideSpinner(panelElement) {
            const overlay = panelElement.querySelector('.spinner-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        // Populate Route Panel and Map Markers
        function renderRoute() {
            routePanel.innerHTML = '<h3><i class="fas fa-route"></i> Your Personalized Route</h3>'; // Clear previous steps
            currentRoute.forEach((step, index) => {
            const stepEl = document.createElement('div');
            stepEl.innerHTML = `
                <div class="icon"><i class="fas ${step.icon}"></i></div>
                <div class="details">
                    <div class="title">${index + 1}. ${step.title}</div>
                    <div class="time">${step.time}</div>
                </div>
                <div>
                    <button class="remove-step-btn" title="Remove step">&times;</button>
                </div>
            `;
            stepEl.className = 'route-step';
            routePanel.appendChild(stepEl);

            // Make route step clickable
            stepEl.style.cursor = 'pointer';
            stepEl.addEventListener('click', () => {
                map.flyTo(step.coords, 15);
            });
            localStorage.setItem(`${visitorId}_lastLocation`, step.title);

            // Add marker to map
            const marker = L.marker(step.coords).addTo(map)
                .bindPopup(`<b>${step.title}</b><br>${step.time}`)
                .openPopup();
            initialRouteMarkers.push(marker);
            
            // Add logic to the remove button
            const removeBtn = stepEl.querySelector('.remove-step-btn');
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the flyTo event
                stepEl.remove();
                currentRoute = currentRoute.filter(item => item.id !== step.id);
                updateVisitedPlacesCount(); // Update count on removal
                updateAverageCrowdLevel(); // Update crowd level on removal
                logActivity(`Removed "${step.title}" from route.`, 'fas fa-times-circle', 'info');
                renderRoute(); // Re-render the entire route to update numbers and map
            });
            });

            // Clear old markers and lines
            initialRouteMarkers.forEach(m => map.removeLayer(m));
            initialRouteMarkers = [];
            if (window.routeLine) map.removeLayer(window.routeLine);

            const routeCoordinates = currentRoute.map(step => step.coords);
            currentRoute.forEach(step => {
                const marker = L.marker(step.coords).addTo(map).bindPopup(`<b>${step.title}</b>`);
                initialRouteMarkers.push(marker);
            });

            if (routeCoordinates.length > 1) {
                window.routeLine = L.polyline(routeCoordinates, { color: 'var(--primary)', weight: 5, opacity: 0.7 }).addTo(map);
                map.fitBounds(window.routeLine.getBounds().pad(0.1));
            } else if (routeCoordinates.length === 1) {
                routeLine.setLatLngs(routeCoordinates);
                map.flyTo(routeCoordinates[0], 15);
            }
        }
        renderRoute();
        updateVisitedPlacesCount(); // Set initial counts
        updateAverageCrowdLevel();

        // Add event listeners for the "Add to Route" buttons
        document.querySelectorAll('.add-to-route-btn').forEach(button => {
            button.addEventListener('click', function() {
                const suggestionTitle = this.getAttribute('data-suggestion-title');
                const suggestion = suggestionsData.find(s => s.title === suggestionTitle);

                if (suggestion && !currentRoute.some(r => r.title === suggestion.title)) {
                    // Create a new route item from the suggestion
                    const newRouteItem = {
                        id: Date.now(), // Use timestamp for a unique ID
                        title: suggestion.title,
                        time: "Time to be confirmed",
                        icon: suggestion.icon,
                        coords: suggestion.coords,
                        crowdLevel: Math.floor(Math.random() * (80 - 50) + 50) // Assign a random crowd level
                    };

                    currentRoute.push(newRouteItem);
                    renderRoute(); // Re-render the route list and map
                    updateVisitedPlacesCount();
                    updateAverageCrowdLevel();
                    logActivity(`Added "${suggestion.title}" to route.`, 'fas fa-plus-circle', 'entry');
                }
            });
        });

        // --- START: Location-Aware Suggestions Logic ---

        // Haversine formula to calculate distance between two points in km
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                0.5 - Math.cos(dLat) / 2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function updateSuggestionsBasedOnLocation(userCoords) {
            const [userLat, userLng] = userCoords;

            // --- START: Phobia-Aware Filtering ---
            const dietaryPrefs = JSON.parse(localStorage.getItem(`${visitorId}_dietaryPreferences`) || '{}');
            const hasCrowdPhobia = dietaryPrefs.phobias && dietaryPrefs.phobias.includes('crowds');
            const hasHeightsPhobia = dietaryPrefs.phobias && dietaryPrefs.phobias.includes('heights');

            let filteredSuggestions = allSuggestions;
            if (hasCrowdPhobia) {
                filteredSuggestions = allSuggestions.filter(s => !s.crowdLevel || s.crowdLevel < 50); // Only show places with crowd level below 50
            }
            if (hasHeightsPhobia) {
                filteredSuggestions = filteredSuggestions.filter(s => !s.isHigh); // Remove places marked as high
            }
            // --- END: Phobia-Aware Filtering ---

            // Calculate distance for each suggestion using the filtered list
            const suggestionsWithDistance = filteredSuggestions
                .filter(s => s.coords) // Only consider suggestions with coordinates
                .map(suggestion => {
                    const distance = getDistance(userLat, userLng, suggestion.coords[0], suggestion.coords[1]);
                    return { ...suggestion, distance };
                });

            // Sort by distance (nearest first)
            suggestionsWithDistance.sort((a, b) => a.distance - b.distance);

            // Get real-time alerts and the 4 nearest places
            const realTimeAlerts = filteredSuggestions.filter(s => s.realTime && !s.coords);
            const nearbyPlaces = suggestionsWithDistance.slice(0, 4);

            renderSuggestions([...realTimeAlerts, ...nearbyPlaces]);
        }

        function renderSuggestions(suggestionsToRender) {
            hideSpinner(suggestionsPanel);
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>'; // Clear previous

            // Clear old suggestion markers from map
            initialSuggestionMarkers.forEach(m => map.removeLayer(m));
            initialSuggestionMarkers = [];

            if (suggestionsToRender.length === 0) {
                suggestionsPanel.innerHTML += '<p>No suggestions found nearby.</p>';
                return;
            }

            suggestionsToRender.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = `suggestion-item ${suggestion.realTime ? 'real-time' : ''}`;

                let infoHtml = suggestion.info;
                if (suggestion.rating) {
                    infoHtml += ` <span class="rating"><i class="fas fa-star"></i> ${suggestion.rating}</span>`;
                }
                // Add distance if available
                if (suggestion.distance !== undefined) {
                    infoHtml += ` <br><b><i class="fas fa-walking"></i> Approx. ${suggestion.distance.toFixed(1)} km away</b>`;
                }

                let addButtonHtml = '';
                if (suggestion.coords) {
                    addButtonHtml = `<button class="add-to-route-btn" data-suggestion-title="${suggestion.title}"><i class="fas fa-plus"></i> Add to Route</button>`;
                }

                suggestionEl.innerHTML = `
                    <div class="icon"><i class="fas ${suggestion.icon}"></i></div>
                    <div class="details">
                        <div class="title">${suggestion.title}</div>
                        <div class="info">${infoHtml}</div>
                        ${addButtonHtml}
                    </div>
                `;
                suggestionsPanel.appendChild(suggestionEl);

                // Add new markers to map
                if (suggestion.coords) {
                    const marker = L.marker(suggestion.coords, {
                        icon: L.divIcon({
                            className: 'suggestion-marker',
                            html: `<i class="fas fa-lightbulb" style="color: var(--accent); font-size: 1.5rem;"></i>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }).addTo(map).bindPopup(`<b>Suggestion:</b><br>${suggestion.title}`);
                    initialSuggestionMarkers.push(marker);
                }
            });

            // Re-attach event listeners for the new "Add to Route" buttons
            suggestionsPanel.querySelectorAll('.add-to-route-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const suggestionTitle = this.getAttribute('data-suggestion-title');
                    const suggestion = filteredSuggestions.find(s => s.title === suggestionTitle);
                    // The rest of the add to route logic is already handled by the original event listener setup
                    // This is a simplified re-attachment. For robustness, the original listener should be attached here.
                });
            });
        }

        function renderLuxuryRestaurants(restaurants) {
            hideSpinner(suggestionsPanel);
            const restaurantMarkers = [];

            restaurants.forEach(restaurant => {
                // Add to sidebar
                const restaurantEl = document.createElement('div');
                restaurantEl.className = 'suggestion-item';
                restaurantEl.innerHTML = `
                    <div class="icon"><i class="fas ${restaurant.icon}"></i></div>
                    <div class="details">
                        <div class="title">${restaurant.name}</div>
                        <div class="info">
                            ${restaurant.info}<br>
                            <b>Price:</b> ${restaurant.price} | <b>Calories:</b> ${restaurant.calories}
                        </div>
                    </div>
                `;
                suggestionsPanel.appendChild(restaurantEl);

                // Add marker to map
                if (restaurant.coords) {
                    const marker = L.marker(restaurant.coords).addTo(map)
                        .bindPopup(`<b>${restaurant.name}</b><br>${restaurant.info}<br>Price: ${restaurant.price}`)
                        .openPopup();
                    restaurantMarkers.push(marker);
                }
            });

            // Fit map to restaurant markers
            if (restaurantMarkers.length > 0) {
                const group = new L.featureGroup(restaurantMarkers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }
        // --- END: Location-Aware Suggestions Logic ---

        // Check for requests when the page loads, after a small delay to let the map initialize
        setTimeout(checkForSpecialRequests, 500);

        // --- END: Location-Aware Suggestions Logic ---

        // 5. Directions Logic
        const getDirectionsBtn = document.getElementById('get-directions-btn');
        const directionsInstructions = document.getElementById('directions-instructions');
        let isPlanningRoute = false;
        let routeWaypoints = [];
        let directionPointMarkers = [];

        getDirectionsBtn.addEventListener('click', () => {
            isPlanningRoute = !isPlanningRoute;
            if (isPlanningRoute) {
                getDirectionsBtn.classList.add('active');
                getDirectionsBtn.textContent = 'Cancel Directions';
                directionsInstructions.textContent = 'Click on the map to set a starting point.';
                map.on('click', onMapClickForDirections);
                document.getElementById('map').style.cursor = 'crosshair';
            } else {
                resetDirections();
            }
        });

        function onMapClickForDirections(e) {
            routeWaypoints.push(e.latlng);
            if (routeWaypoints.length === 1) {
                directionsInstructions.textContent = 'Click on the map to set an ending point.';
                const startMarker = L.marker(e.latlng, { title: 'Start' }).addTo(map);
                directionPointMarkers.push(startMarker);
            } else if (routeWaypoints.length === 2) {
                directionsInstructions.textContent = 'Calculating route...';
                const endMarker = L.marker(e.latlng, { title: 'End' }).addTo(map);
                directionPointMarkers.push(endMarker);
                
                directionsControl = L.Routing.control({
                    waypoints: routeWaypoints,
                    routeWhileDragging: true,
                    show: false, // We hide the default instructions panel from the plugin
                    lineOptions: {
                        styles: [{color: 'var(--accent)', opacity: 0.8, weight: 7}]
                    }
                }).addTo(map);

                isPlanningRoute = false;
                getDirectionsBtn.textContent = 'Clear Route';
                getDirectionsBtn.classList.add('active'); // Keep it active to show a route is present
                document.getElementById('map').style.cursor = '';
                map.off('click', onMapClickForDirections);
            }
        }

        function resetDirections() {
            if (directionsControl) map.removeControl(directionsControl);
            getDirectionsBtn.classList.remove('active');
            getDirectionsBtn.textContent = 'Start Planning Route';
            directionsInstructions.textContent = '';
            routeWaypoints = [];
            directionPointMarkers.forEach(marker => map.removeLayer(marker));
            directionPointMarkers = [];
            document.getElementById('map').style.cursor = '';
            map.off('click', onMapClickForDirections);
        }

        // Clear Markers Button Logic
        const clearMarkersBtn = document.getElementById('clear-markers-btn');
        clearMarkersBtn.addEventListener('click', () => {
            // This removes markers from the AI agent and the directions tool
            suggestionMarkers.forEach(marker => map.removeLayer(marker));
            // Also clear initial suggestion markers
            initialSuggestionMarkers.forEach(marker => map.removeLayer(marker));
            initialSuggestionMarkers = [];
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>';
            suggestionMarkers = [];
            resetDirections();
        });
    </script>
    <script>
        // Simulate initial data fetching on page load
        window.addEventListener('load', () => {
            const routePanel = document.getElementById('route-panel');
            const suggestionsPanel = document.getElementById('suggestions-panel');

            showSpinner(routePanel);
            showSpinner(suggestionsPanel);

            setTimeout(() => {
                hideSpinner(routePanel);
                hideSpinner(suggestionsPanel);
                // Suggestions will now be populated after geolocation.
                // If it were fetched, we'd populate it here.
            }, 1500); // Simulate a 1.5-second load time
        });
    </script>

    <!-- AI Agent Script -->
    <script>
        const aiAgentBtn = document.getElementById('ai-agent-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiCloseBtn = document.getElementById('ai-close-btn');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiUserInput = document.getElementById('ai-user-input');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        let suggestionMarkers = [];
        const aiModalContent = document.querySelector('.ai-modal-content');
        const aiModalHeader = document.querySelector('.ai-modal-header');

        // Expanded Mood & Feeling Database
        const feelingSuggestions = {
            'uplifting': {
                keywords: ['happy', 'confident', 'proud', 'grateful', 'hopeful', 'excited', 'joyful', 'satisfied', 'optimistic', 'content', 'secure', 'loving', 'motivated', 'determined', 'outgoing', 'bold', 'energized', 'hyper', 'strong', 'refreshed', 'eager', 'enthusiastic', 'amused'],
                response: "It's wonderful that you're feeling positive! Here are some places to match your great energy:",
                places: [
                    { name: "Kite Beach", info: "Enjoy the sun, sand, and vibrant social atmosphere.", coords: [25.1825, 55.2264] },
                    { name: "Global Village", info: "Experience cultures from around the world with lively shows and food.", coords: [25.0711, 55.3084] },
                    { name: "City Walk", info: "An open-air mall with street art, fountains, and great shopping.", coords: [25.2093, 55.2504] }
                ]
            },
            'calming': {
                keywords: ['sad', 'ashamed', 'guilty', 'lonely', 'hopeless', 'miserable', 'depressed', 'pessimistic', 'insecure', 'betrayed', 'unmotivated', 'excluded', 'unappreciated', 'unsupported', 'disconnected', 'nostalgic', 'compassionate', 'empathetic'],
                response: "I'm sorry to hear you're feeling this way. Sometimes a change of scenery can help. Here are some peaceful spots:",
                places: [
                    { name: "Al Fahidi Historical Neighbourhood", info: "Take a quiet, reflective stroll through Dubai's past.", coords: [25.2630, 55.2970] },
                    { name: "The Green Planet", info: "Immerse yourself in the calming sounds of a tropical rainforest.", coords: [25.2093, 55.2504] },
                    { name: "Jumeirah Public Beach", info: "Listen to the gentle waves and watch the sea.", coords: [25.2155, 55.2494] }
                ]
            },
            'de-stress': {
                keywords: ['angry', 'jealous', 'annoyed', 'frustrated', 'irritated', 'resentful', 'spiteful', 'hateful', 'stressed', 'overwhelmed', 'tense'],
                response: "It's okay to feel that way. Here are some places where you can channel that intense energy:",
                places: [
                    { name: "The Smash Room", info: "A safe and fun place to release frustration by breaking things.", coords: [25.1378, 55.2204] },
                    { name: "Dubai Autodrome", info: "Experience the thrill of high-speed karting to focus your mind.", coords: [25.0478, 55.2396] },
                    { name: "A high-intensity gym class", info: "Channel your energy into a productive workout.", coords: null }
                ]
            },
            'relaxing': {
                keywords: ['scared', 'nervous', 'embarrassed', 'worried', 'awkward', 'defensive', 'shaky', 'panicked', 'unsafe', 'unstable', 'out-of-control', 'powerless', 'doubtful', 'anxious', 'calm', 'peaceful', 'relaxed'],
                response: "Let's find a place where you can feel calm and secure. Here are some relaxing suggestions:",
                places: [
                    { name: "Talise Ottoman Spa", info: "Indulge in world-class spa treatments to relax your body and mind.", coords: [25.0933, 55.1256] },
                    { name: "Dubai Miracle Garden", info: "Wander through a beautiful and serene floral wonderland.", coords: [25.0558, 55.2464] },
                    { name: "A quiet library or lounge", info: "Find a peaceful corner to read or simply be.", coords: null }
                ]
            },
            'rejuvenating': {
                keywords: ['tired', 'exhausted', 'sleepy', 'lazy', 'weak', 'drained', 'sluggish', 'sore', 'stiff', 'achy'],
                response: "It sounds like you need to recharge. Here are some ideas to help you feel refreshed:",
                places: [
                    { name: "A relaxing spa", info: "A massage or gentle treatment can do wonders.", coords: [25.1972, 55.2744] },
                    { name: "Safa Park", info: "A gentle walk in a beautiful green space can be very restorative.", coords: [25.1958, 55.2444] },
                    { name: "A cozy cinema", info: "Relax in a comfortable seat and escape into a movie.", coords: [25.1983, 55.2795] }
                ]
            },
            'physical-needs': {
                keywords: ['hungry', 'starving', 'thirsty', 'dehydrated', 'craving', 'parched', 'sick', 'nauseated', 'dizzy', 'faint', 'painful', 'uncomfortable'],
                response: "Let's take care of that. Here are some suggestions based on what your body is telling you:",
                places: [
                    { name: "Time Out Market", info: "A food hall with many options to satisfy any craving.", coords: [25.2028, 55.2833] },
                    { name: "A local pharmacy", info: "For when you're feeling sick or need basic medical supplies.", coords: null },
                    { name: "A quiet cafe", info: "A good place to rehydrate and rest if you're feeling unwell.", coords: [25.2163, 55.2831] }
                ]
            }
        };

        aiAgentBtn.addEventListener('click', () => {
            aiModal.style.display = 'flex';
            // Center the modal on open
            aiModalContent.style.top = `calc(50% - ${aiModalContent.offsetHeight / 2}px)`;
            aiModalContent.style.left = `calc(50% - ${aiModalContent.offsetWidth / 2}px)`;


            if (aiChatMessages.children.length === 0) {
                addAiMessage("Hello! Tell me how you're feeling today, and I'll suggest some places for you.", 'bot');
            }
        });

        aiCloseBtn.addEventListener('click', () => {
            aiModal.style.display = 'none';
        });

        aiSendBtn.addEventListener('click', handleUserQuery);
        aiUserInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserQuery();
        });

        function handleUserQuery() {
            const message = aiUserInput.value.trim();
            if (!message) return;

            addAiMessage(message, 'user');
            aiUserInput.value = '';

            processUserFeeling(message.toLowerCase());
        }

        function addAiMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.className = `ai-message ${sender === 'user' ? 'ai-user-msg' : 'ai-bot-msg'}`;
            messageEl.innerHTML = text; // Using innerHTML to render links if any
            aiChatMessages.appendChild(messageEl);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }

        function processUserFeeling(message) {
            let categoryFound = null;

            // Find which category the user's input falls into
            for (const category in feelingSuggestions) {
                const { keywords } = feelingSuggestions[category];
                if (keywords.some(keyword => message.includes(keyword))) {
                    categoryFound = category;
                    break;
                }
            }

            // Categories that indicate a "bad feeling"
            const badFeelingCategories = ['calming', 'de-stress', 'relaxing', 'rejuvenating', 'physical-needs'];

            if (categoryFound && badFeelingCategories.includes(categoryFound)) {
                let currentBadFeelings = parseInt(localStorage.getItem(`${visitorId}_badFeelingsCount`) || '0', 10);
                localStorage.setItem(`${visitorId}_badFeelingsCount`, currentBadFeelings + 1);
                logActivity(`User reported feeling ${message}.`, 'fas fa-heart-broken', 'alert');
            }
            
            // Log food-related requests for the chef
            if (categoryFound === 'physical-needs' && message.includes('hungry') || message.includes('craving') || message.includes('thirsty')) {
                let foodRequests = JSON.parse(localStorage.getItem(`${visitorId}_foodRequests`) || '[]');
                const requestText = `طلب: "${message}"`;
                if (!foodRequests.includes(requestText)) {
                    foodRequests.push(requestText);
                    localStorage.setItem(`${visitorId}_foodRequests`, JSON.stringify(foodRequests));
                }
            }

            // Clear previous suggestion markers from the map
            suggestionMarkers.forEach(marker => map.removeLayer(marker));
            suggestionMarkers = [];
            
            suggestionsPanel.innerHTML = '<h3><i class="fas fa-lightbulb"></i> Real-Time Suggestions</h3>';
            showSpinner(suggestionsPanel);

            if (categoryFound) {
                const { response, places } = feelingSuggestions[categoryFound];
                let botResponse = response + "<br><br>";

                places.forEach(place => {
                    botResponse += `<b>${place.name}:</b> ${place.info}<br>`;
                    if (place.coords) {
                        const marker = L.marker(place.coords).addTo(map)
                            .bindPopup(`<b>Suggestion:</b><br>${place.name}`)
                            .openPopup();
                        suggestionMarkers.push(marker);
                    }
                });
                addAiMessage(botResponse, 'bot');

                hideSpinner(suggestionsPanel);
                // Populate the panel with the new places
                populateSuggestionsFromAI(places);

                // Fit map to new markers
                if (suggestionMarkers.length > 0) {
                    const group = new L.featureGroup(suggestionMarkers);
                    map.fitBounds(group.getBounds().pad(0.5));
                }
            } else {
                hideSpinner(suggestionsPanel);
                addAiMessage("I'm sorry, I'm not sure how to help with that feeling. Try telling me if you're 'happy', 'tired', 'stressed', or 'hungry'.", 'bot');
            }
        }

        // Draggable Modal Logic
        let isDragging = false;
        let offsetX, offsetY;

        aiModalHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            aiModalContent.style.position = 'absolute'; // Ensure position is absolute for dragging
            offsetX = e.clientX - aiModalContent.offsetLeft;
            offsetY = e.clientY - aiModalContent.offsetTop;
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            if (!isDragging) return;
            
            let newX = e.clientX - offsetX;
            let newY = e.clientY - offsetY;

            // Constrain to viewport
            newX = Math.max(0, Math.min(newX, window.innerWidth - aiModalContent.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - aiModalContent.offsetHeight));

            aiModalContent.style.left = `${newX}px`;
            aiModalContent.style.top = `${newY}px`;
        }

        function onMouseUp() {
            isDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }

        function populateSuggestionsFromAI(places) {
            places.forEach(suggestion => {
                const suggestionEl = document.createElement('div');
                suggestionEl.className = 'suggestion-item';
                suggestionEl.innerHTML = `
                    <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="details">
                        <div class="title">${suggestion.name}</div>
                        <div class="info">${suggestion.info}</div>
                    </div>
                `;

                if (suggestion.coords) {
                    suggestionEl.style.cursor = 'pointer';
                    suggestionEl.addEventListener('click', () => {
                        map.flyTo(suggestion.coords, 15);
                    });
                }

                suggestionsPanel.appendChild(suggestionEl);
            });
        }
    </script>

</body>
</html>